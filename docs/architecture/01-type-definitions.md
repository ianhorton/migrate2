# Type Definitions and Interfaces

## Core Domain Types

### Resource Types

```typescript
/**
 * Represents a CloudFormation resource with metadata
 */
export interface Resource {
  /** Logical ID in CloudFormation template */
  logicalId: string;

  /** Physical ID in AWS (actual resource name) */
  physicalId: string;

  /** CloudFormation resource type (e.g., AWS::DynamoDB::Table) */
  type: string;

  /** Resource properties from CloudFormation */
  properties: Record<string, unknown>;

  /** Resource classification for migration strategy */
  classification: ResourceClassification;

  /** Where this resource was defined */
  source: ResourceSource;

  /** Resources this depends on (logical IDs) */
  dependencies: string[];

  /** CloudFormation deletion policy */
  deletionPolicy?: DeletionPolicy;

  /** CloudFormation update/replace policy */
  updateReplacePolicy?: UpdateReplacePolicy;

  /** Custom metadata */
  metadata?: Record<string, unknown>;
}

export enum ResourceClassification {
  /** Resource must be imported (stateful) */
  IMPORT = 'IMPORT',

  /** Resource will be recreated (stateless) */
  RECREATE = 'RECREATE',

  /** Resource requires manual migration */
  MANUAL = 'MANUAL',

  /** Resource type not supported */
  UNSUPPORTED = 'UNSUPPORTED'
}

export enum ResourceSource {
  /** Explicitly defined in serverless.yml */
  EXPLICIT = 'EXPLICIT',

  /** Auto-generated by Serverless Framework */
  ABSTRACTED = 'ABSTRACTED',

  /** Custom CloudFormation resource */
  CUSTOM = 'CUSTOM'
}

export enum DeletionPolicy {
  DELETE = 'Delete',
  RETAIN = 'Retain',
  SNAPSHOT = 'Snapshot'
}

export enum UpdateReplacePolicy {
  DELETE = 'Delete',
  RETAIN = 'Retain',
  SNAPSHOT = 'Snapshot'
}

/**
 * Resource inventory from scanning phase
 */
export interface ResourceInventory {
  /** All discovered resources */
  resources: Resource[];

  /** Resources explicitly defined in serverless.yml */
  explicit: Resource[];

  /** Resources auto-generated by Serverless */
  abstracted: Resource[];

  /** Stateful resources that must be imported */
  stateful: Resource[];

  /** Stateless resources that can be recreated */
  stateless: Resource[];

  /** Resources requiring manual handling */
  manual: Resource[];

  /** Unsupported resources */
  unsupported: Resource[];

  /** Dependency graph */
  dependencyGraph: DependencyGraph;

  /** Scan metadata */
  metadata: ScanMetadata;
}

export interface ScanMetadata {
  scanId: string;
  timestamp: Date;
  serverlessStackName: string;
  stage: string;
  region: string;
  serverlessVersion: string;
  nodeVersion: string;
}
```

### Dependency Graph

```typescript
/**
 * Represents resource dependencies
 */
export interface DependencyGraph {
  /** Map of resource ID to its dependencies */
  nodes: Map<string, DependencyNode>;

  /** Topologically sorted resource IDs */
  sortedIds: string[];

  /** Circular dependencies if any */
  circular: CircularDependency[];
}

export interface DependencyNode {
  resourceId: string;

  /** Resources this node depends on */
  dependencies: string[];

  /** Resources that depend on this node */
  dependents: string[];

  /** Dependency type */
  dependencyType: DependencyType[];
}

export enum DependencyType {
  /** Explicit DependsOn in CloudFormation */
  EXPLICIT = 'EXPLICIT',

  /** Implicit via Ref intrinsic function */
  REF = 'REF',

  /** Implicit via GetAtt intrinsic function */
  GET_ATT = 'GET_ATT',

  /** Implicit via Sub intrinsic function */
  SUB = 'SUB'
}

export interface CircularDependency {
  cycle: string[];
  description: string;
}
```

### CloudFormation Templates

```typescript
/**
 * CloudFormation template structure
 */
export interface CloudFormationTemplate {
  AWSTemplateFormatVersion?: string;
  Description?: string;

  /** Template metadata */
  Metadata?: Record<string, unknown>;

  /** Template parameters */
  Parameters?: Record<string, ParameterDefinition>;

  /** Template mappings */
  Mappings?: Record<string, Record<string, Record<string, unknown>>>;

  /** Template conditions */
  Conditions?: Record<string, unknown>;

  /** Template resources (main section) */
  Resources: Record<string, CloudFormationResource>;

  /** Template outputs */
  Outputs?: Record<string, OutputDefinition>;

  /** Transform (e.g., AWS::Serverless-2016-10-31) */
  Transform?: string | string[];
}

export interface CloudFormationResource {
  Type: string;
  Properties?: Record<string, unknown>;
  DependsOn?: string | string[];
  DeletionPolicy?: DeletionPolicy;
  UpdateReplacePolicy?: UpdateReplacePolicy;
  Condition?: string;
  Metadata?: Record<string, unknown>;
}

export interface ParameterDefinition {
  Type: string;
  Default?: unknown;
  Description?: string;
  AllowedValues?: unknown[];
  AllowedPattern?: string;
  ConstraintDescription?: string;
  MinLength?: number;
  MaxLength?: number;
  MinValue?: number;
  MaxValue?: number;
  NoEcho?: boolean;
}

export interface OutputDefinition {
  Description?: string;
  Value: unknown;
  Export?: {
    Name: string;
  };
  Condition?: string;
}
```

### Comparison Types

```typescript
/**
 * Template comparison result
 */
export interface ComparisonReport {
  comparisonId: string;
  timestamp: Date;

  /** Summary statistics */
  summary: ComparisonSummary;

  /** Individual resource comparisons */
  resources: ResourceComparison[];

  /** Overall migration readiness */
  overallStatus: ComparisonStatus;
  readyForImport: boolean;

  /** Issues blocking migration */
  blockingIssues: string[];

  /** Warnings that should be reviewed */
  warnings: string[];
}

export interface ComparisonSummary {
  totalResources: number;
  matched: number;
  unmatchedServerless: number;
  unmatchedCdk: number;

  statusCounts: {
    [ComparisonStatus.MATCH]: number;
    [ComparisonStatus.ACCEPTABLE]: number;
    [ComparisonStatus.WARNING]: number;
    [ComparisonStatus.CRITICAL]: number;
  };
}

export interface ResourceComparison {
  resourceType: string;
  physicalId: string;
  serverlessLogicalId: string;
  cdkLogicalId: string;

  status: ComparisonStatus;
  differences: PropertyDifference[];
  recommendation: string;
}

export enum ComparisonStatus {
  /** Perfect match, no differences */
  MATCH = 'MATCH',

  /** Acceptable differences (e.g., CDK additions) */
  ACCEPTABLE = 'ACCEPTABLE',

  /** Differences that should be reviewed */
  WARNING = 'WARNING',

  /** Critical differences blocking import */
  CRITICAL = 'CRITICAL'
}

export interface PropertyDifference {
  /** Property path (e.g., "Properties.BillingMode") */
  property: string;

  /** Value in Serverless template */
  serverlessValue: unknown;

  /** Value in CDK template */
  cdkValue: unknown;

  /** Severity of difference */
  severity: DifferenceSeverity;

  /** Human-readable explanation */
  explanation: string;

  /** Can this be auto-fixed? */
  autoFixable: boolean;

  /** Suggested fix if autoFixable */
  suggestedFix?: string;
}

export enum DifferenceSeverity {
  CRITICAL = 'CRITICAL',
  WARNING = 'WARNING',
  ACCEPTABLE = 'ACCEPTABLE',
  INFO = 'INFO'
}
```

### Migration State

```typescript
/**
 * Complete migration state
 */
export interface MigrationState {
  /** Unique migration ID */
  migrationId: string;

  /** Current status */
  status: MigrationStatus;

  /** Current step being executed */
  currentStep: MigrationStep;

  /** Successfully completed steps */
  completedSteps: MigrationStep[];

  /** Failed steps with error details */
  failedSteps: FailedStep[];

  /** Migration start time */
  startTime: Date;

  /** Migration end time (if completed) */
  endTime?: Date;

  /** Configuration used for migration */
  config: MigrationConfig;

  /** State of each resource */
  resources: ResourceState[];

  /** Backup references */
  backups: BackupReference[];

  /** Audit trail */
  auditLog: AuditEntry[];
}

export enum MigrationStatus {
  INITIALIZED = 'INITIALIZED',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED',
  ROLLED_BACK = 'ROLLED_BACK',
  CANCELLED = 'CANCELLED'
}

export enum MigrationStep {
  SCAN = 'SCAN',
  PROTECT = 'PROTECT',
  GENERATE = 'GENERATE',
  COMPARE = 'COMPARE',
  REMOVE = 'REMOVE',
  IMPORT = 'IMPORT',
  DEPLOY = 'DEPLOY',
  VERIFY = 'VERIFY',
  CLEANUP = 'CLEANUP'
}

export interface FailedStep {
  step: MigrationStep;
  error: string;
  timestamp: Date;
  stackTrace?: string;
}

export interface ResourceState {
  logicalId: string;
  physicalId: string;
  type: string;

  /** Current status of this resource */
  status: ResourceMigrationStatus;

  /** Step-by-step progress */
  steps: ResourceStepState[];

  /** Any errors encountered */
  errors: string[];
}

export enum ResourceMigrationStatus {
  PENDING = 'PENDING',
  PROTECTED = 'PROTECTED',
  REMOVED = 'REMOVED',
  IMPORTED = 'IMPORTED',
  VERIFIED = 'VERIFIED',
  FAILED = 'FAILED'
}

export interface ResourceStepState {
  step: MigrationStep;
  status: StepStatus;
  timestamp?: Date;
  details?: Record<string, unknown>;
}

export enum StepStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED',
  SKIPPED = 'SKIPPED'
}

export interface BackupReference {
  backupId: string;
  type: BackupType;
  path: string;
  timestamp: Date;
  size: number;
}

export enum BackupType {
  CLOUDFORMATION_TEMPLATE = 'CLOUDFORMATION_TEMPLATE',
  MIGRATION_STATE = 'MIGRATION_STATE',
  RESOURCE_CONFIG = 'RESOURCE_CONFIG'
}

export interface AuditEntry {
  timestamp: Date;
  step: MigrationStep;
  action: string;
  details: Record<string, unknown>;
  user?: string;
}
```

### Configuration Types

```typescript
/**
 * Migration configuration
 */
export interface MigrationConfig {
  /** Serverless configuration */
  serverless: ServerlessConfig;

  /** CDK configuration */
  cdk: CdkConfig;

  /** Resource filters */
  resources: ResourceFilters;

  /** Migration options */
  options: MigrationOptions;

  /** AWS configuration */
  aws?: AwsConfig;
}

export interface ServerlessConfig {
  /** Path to serverless.yml directory */
  path: string;

  /** Serverless stack name */
  stackName: string;

  /** Deployment stage */
  stage: string;

  /** AWS region */
  region: string;

  /** Custom Serverless config file name */
  configFile?: string;
}

export interface CdkConfig {
  /** Path to CDK project directory */
  path: string;

  /** CDK stack name */
  stackName: string;

  /** AWS region */
  region: string;

  /** CDK language */
  language: CdkLanguage;

  /** CDK version */
  cdkVersion?: string;

  /** Use L2 constructs vs L1 */
  useL2Constructs?: boolean;
}

export enum CdkLanguage {
  TYPESCRIPT = 'typescript',
  PYTHON = 'python',
  JAVA = 'java',
  CSHARP = 'csharp',
  GO = 'go'
}

export interface ResourceFilters {
  /** Include only these resource types */
  includeTypes?: string[];

  /** Exclude these resource types */
  excludeTypes?: string[];

  /** Include only these specific resources */
  includeResources?: string[];

  /** Exclude these specific resources */
  excludeResources?: string[];
}

export interface MigrationOptions {
  /** Run in dry-run mode (no changes) */
  dryRun: boolean;

  /** Interactive mode with prompts */
  interactive: boolean;

  /** Auto-approve all steps */
  autoApprove: boolean;

  /** Create backups before operations */
  createBackups: boolean;

  /** Verify after each step */
  verifyAfterEachStep: boolean;

  /** Continue on non-critical errors */
  continueOnError: boolean;

  /** Verbose logging */
  verbose: boolean;

  /** Output directory for reports */
  outputDir?: string;
}

export interface AwsConfig {
  /** AWS profile name */
  profile?: string;

  /** AWS access key ID */
  accessKeyId?: string;

  /** AWS secret access key */
  secretAccessKey?: string;

  /** AWS session token */
  sessionToken?: string;

  /** Custom endpoint (for testing) */
  endpoint?: string;
}
```

### Result Types

```typescript
/**
 * Operation results
 */
export interface StepResult {
  success: boolean;
  step: MigrationStep;
  data?: unknown;
  error?: string;
  warnings?: string[];
  duration?: number;
}

export interface MigrationResult {
  success: boolean;
  migrationId?: string;
  failedStep?: MigrationStep;
  error?: string;
  cancelled?: boolean;
  summary?: MigrationSummary;
}

export interface MigrationSummary {
  totalResources: number;
  migratedResources: number;
  failedResources: number;
  skippedResources: number;
  duration: number;
  steps: StepSummary[];
}

export interface StepSummary {
  step: MigrationStep;
  status: StepStatus;
  duration: number;
  resourcesProcessed: number;
}

export interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

export interface VerificationResult {
  success: boolean;
  checks: VerificationCheck[];
  driftDetected: boolean;
  driftDetails?: DriftDetail[];
}

export interface VerificationCheck {
  name: string;
  passed: boolean;
  message?: string;
}

export interface DriftDetail {
  resourceId: string;
  physicalId: string;
  driftStatus: string;
  propertyDifferences: PropertyDifference[];
}

export interface RollbackResult {
  success: boolean;
  targetStep: MigrationStep;
  actionsPerformed: RollbackAction[];
  error?: string;
}

export interface RollbackAction {
  action: string;
  resourceId?: string;
  success: boolean;
  details?: string;
}
```

### Code Generation Types

```typescript
/**
 * Generated CDK code
 */
export interface GeneratedCode {
  /** Main stack file content */
  mainFile: string;

  /** Import statements */
  imports: string[];

  /** Individual construct code blocks */
  constructs: ConstructCode[];

  /** Supporting files (app.ts, cdk.json, etc.) */
  supportingFiles: GeneratedFile[];

  /** Warnings during generation */
  warnings: string[];
}

export interface ConstructCode {
  /** Construct variable name */
  name: string;

  /** CloudFormation resource type */
  resourceType: string;

  /** Generated code */
  code: string;

  /** Comments to include */
  comments: string[];

  /** Dependencies on other constructs */
  dependencies: string[];
}

export interface GeneratedFile {
  path: string;
  content: string;
  description?: string;
}

export interface GeneratorConfig {
  language: CdkLanguage;
  stackName: string;
  cdkVersion: string;
  useL2Constructs: boolean;
  includeComments: boolean;
  preserveLogicalIds: boolean;
  formatting: FormattingOptions;
}

export interface FormattingOptions {
  indentSize: number;
  useTabs: boolean;
  semicolons: boolean;
  singleQuote: boolean;
  trailingComma: 'none' | 'es5' | 'all';
}
```

## Type Guards and Utilities

```typescript
/**
 * Type guard utilities
 */
export namespace TypeGuards {
  export function isResource(obj: unknown): obj is Resource {
    return (
      typeof obj === 'object' &&
      obj !== null &&
      'logicalId' in obj &&
      'physicalId' in obj &&
      'type' in obj
    );
  }

  export function isCloudFormationTemplate(
    obj: unknown
  ): obj is CloudFormationTemplate {
    return (
      typeof obj === 'object' &&
      obj !== null &&
      'Resources' in obj &&
      typeof (obj as CloudFormationTemplate).Resources === 'object'
    );
  }

  export function isMigrationState(obj: unknown): obj is MigrationState {
    return (
      typeof obj === 'object' &&
      obj !== null &&
      'migrationId' in obj &&
      'status' in obj &&
      'currentStep' in obj
    );
  }
}
```
